<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>í”„ë¦¬ì…€</title>
<style>
  :root{
    --bg:#050816;
    --panel:#090e1f;
    --ink:#e9edff;
    --muted:#9aa3c7;
    --line:#222747;
    --accent:#7aa2ff;
    --accent2:#22c55e;
    --danger:#fb7185;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:radial-gradient(circle at top,#151b3c 0,#050816 55%);
    color:var(--ink);
    font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto;
  }
  .wrap{
    max-width:1024px;
    margin:0 auto;
    padding:16px;
  }
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:8px;
  }
  h1{
    margin:0;
    font-size:22px;
    letter-spacing:0.02em;
    display:flex;
    align-items:center;
    gap:8px;
  }
  h1 span.logo-dot{
    width:24px;
    height:24px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 20%,#f97316,#ec4899);
    box-shadow:0 0 16px rgba(236,72,153,.9);
  }
  .subtitle{
    font-size:12px;
    color:var(--muted);
  }
  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .btn{
    padding:8px 12px;
    border:1px solid #2a315e;
    border-radius:999px;
    background:#111834;
    color:var(--ink);
    cursor:pointer;
    font-size:13px;
    line-height:1.2;
    white-space:nowrap;
  }
  .btn-primary{
    background:linear-gradient(180deg,#3650ff,#2330b7);
    border-color:#4a5bff;
  }
  .btn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .btn-pill{
    background:#0f172a;
  }
  .btn-pill.active{
    background:var(--accent);
    border-color:var(--accent);
    color:#fff;
  }
  .layout{
    display:grid;
    grid-template-columns:minmax(0,3fr) minmax(0,2.3fr);
    gap:14px;
  }
  @media (max-width:880px){
    .layout{grid-template-columns:1fr;}
  }
  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.8);
  }
  .game-shell{
    background:#020414;
    border-radius:16px;
    padding:10px;
    border:1px solid #181e3a;
  }
  .hud{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin:8px 0 6px;
  }
  .tag{
    display:inline-flex;
    gap:6px;
    align-items:center;
    padding:6px 10px;
    border:1px solid #2b325c;
    border-radius:999px;
    background:#10152f;
    color:var(--muted);
    font-size:13px;
  }
  .tag b{
    font-weight:600;
    color:var(--ink);
    min-width:2ch;
    text-align:right;
  }
  .pill-label{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid #334155;
    background:#020617;
    font-size:12px;
    color:var(--muted);
  }
  .big-btn{
    width:100%;
    margin-top:8px;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid #166534;
    background:linear-gradient(180deg,#22c55e,#15803d);
    color:#022c22;
    font-weight:600;
    text-align:center;
    cursor:pointer;
  }
  .big-btn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .status-msg{
    margin-top:6px;
    font-size:13px;
    color:var(--muted);
    min-height:18px;
  }
  .status-msg.positive{color:#4ade80;}
  .status-msg.negative{color:var(--danger);}

  .hint{
    color:var(--muted);
    font-size:13px;
    margin-top:6px;
  }
  .hint ul{
    padding-left:18px;
    margin:4px 0 0;
  }
  .hint li{margin-bottom:2px;}

  footer{
    color:var(--muted);
    font-size:13px;
    margin-top:14px;
    text-align:left;
  }

  /* --- í”„ë¦¬ì…€ ì „ìš© ë³´ë“œ / ì¹´ë“œ ìŠ¤íƒ€ì¼ --- */
  .board{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .board-top{
    display:grid;
    grid-template-columns:repeat(4,1fr) 16px repeat(4,1fr);
    gap:8px;
    margin-bottom:4px;
  }
  .board-bottom{
    display:grid;
    grid-template-columns:repeat(8,1fr);
    gap:8px;
    min-height:260px;
  }
  .pile{
    position:relative;
    padding:6px;
    border-radius:12px;
    border:1px dashed #1f2937;
    background:radial-gradient(circle at top,#020617,#020314);
    box-shadow:0 10px 25px rgba(0,0,0,.6);
  }
  .pile.pile-foundation{
    border-style:solid;
    border-color:#4b5563;
  }
  .pile-label{
    font-size:11px;
    color:var(--muted);
    margin-bottom:4px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .pile-label .symbol{
    font-size:14px;
  }
  .pile-body{
    position:relative;
    min-height:80px;
  }
  .board-bottom .pile .pile-body{
    min-height:220px;
  }

  .card{
    position:absolute;
    left:0;
    right:0;
    margin:0 auto;
    width:100%;
    max-width:80px;
    aspect-ratio:3/4;
    border-radius:10px;
    background:radial-gradient(circle at top,#f9fafb,#e5e7eb);
    box-shadow:0 8px 18px rgba(15,23,42,0.8);
    border:1px solid #e5e7eb;
    padding:4px 6px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    cursor:pointer;
    transition:transform .08s ease-out, box-shadow .08s ease-out;
  }
  .card:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 24px rgba(15,23,42,0.9);
  }
  .card.red{
    color:#ef4444;
  }
  .card.black{
    color:#0f172a;
  }

  /* ì—¬ê¸°ì„œë¶€í„°: ì¹´ë“œ ì•ˆ ê¸€ì ë“œë˜ê·¸ ë°©ì§€ */
  .card, .card *{
    -webkit-user-select:none;
    -moz-user-select:none;
    -ms-user-select:none;
    user-select:none;
  }

  .card-rank{
    font-size:14px;
    font-weight:700;
  }
  .card-suit{
    font-size:16px;
    align-self:flex-end;
  }
  .card-center{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:24px;
    opacity:.3;
  }
  .card.selected{
    outline:2px solid var(--accent);
    box-shadow:0 0 0 2px #1d4ed8,0 16px 32px rgba(59,130,246,0.65);
  }
  .pile-empty-hint{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    color:#1f2937;
    opacity:.35;
    pointer-events:none;
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1><span class="logo-dot"></span>ë„¤ì˜¨ í”„ë¦¬ì…€</h1>
      <div class="subtitle">ëœë¤ íƒ€ì›Œ ë””íœìŠ¤ì™€ ë™ì¼í•œ UI í†¤ì˜ HTML5 í”„ë¦¬ì…€ ì¹´ë“œ ê²Œì„</div>
    </div>
    <div class="row">
      <button id="btn-new" class="btn btn-primary">ìƒˆ ê²Œì„</button>
    </div>
  </header>

  <div class="layout">
    <!-- ì™¼ìª½ : ê²Œì„ í™”ë©´ -->
    <section class="panel">
      <div class="hud">
        <span class="tag">ì´ë™ ìˆ˜ <b id="moves">0</b></span>
        <span class="tag">ê²½ê³¼ ì‹œê°„ <b id="time">0:00</b></span>
        <span class="tag">ìƒíƒœ <b id="state">í”Œë ˆì´ ì¤‘</b></span>
      </div>

      <div class="game-shell">
        <div id="board" class="board">
          <div class="board-top">
            <!-- Free cells -->
            <div class="pile pile-free" data-pile-type="free" data-index="0">
              <div class="pile-label"><span>FREE 1</span></div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">â˜…</div>
            </div>
            <div class="pile pile-free" data-pile-type="free" data-index="1">
              <div class="pile-label"><span>FREE 2</span></div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">â˜…</div>
            </div>
            <div class="pile pile-free" data-pile-type="free" data-index="2">
              <div class="pile-label"><span>FREE 3</span></div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">â˜…</div>
            </div>
            <div class="pile pile-free" data-pile-type="free" data-index="3">
              <div class="pile-label"><span>FREE 4</span></div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">â˜…</div>
            </div>

            <div></div> <!-- spacer -->

            <!-- Foundations (ìŠ¤í˜ì´ë“œ / í•˜íŠ¸ / í´ë¡œë²„ / ë‹¤ì´ì•„ëª¬ë“œ) -->
            <div class="pile pile-foundation" data-pile-type="foundation" data-index="0">
              <div class="pile-label">
                <span>ê¸°ì´ˆ 1</span><span class="symbol">â™ </span>
              </div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">A</div>
            </div>
            <div class="pile pile-foundation" data-pile-type="foundation" data-index="1">
              <div class="pile-label">
                <span>ê¸°ì´ˆ 2</span><span class="symbol">â™¥</span>
              </div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">A</div>
            </div>
            <div class="pile pile-foundation" data-pile-type="foundation" data-index="2">
              <div class="pile-label">
                <span>ê¸°ì´ˆ 3</span><span class="symbol">â™£</span>
              </div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">A</div>
            </div>
            <div class="pile pile-foundation" data-pile-type="foundation" data-index="3">
              <div class="pile-label">
                <span>ê¸°ì´ˆ 4</span><span class="symbol">â™¦</span>
              </div>
              <div class="pile-body"></div>
              <div class="pile-empty-hint">A</div>
            </div>
          </div>

          <!-- Cascades -->
          <div class="board-bottom">
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="0">
              <div class="pile-label"><span>ì—´ 1</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="1">
              <div class="pile-label"><span>ì—´ 2</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="2">
              <div class="pile-label"><span>ì—´ 3</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="3">
              <div class="pile-label"><span>ì—´ 4</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="4">
              <div class="pile-label"><span>ì—´ 5</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="5">
              <div class="pile-label"><span>ì—´ 6</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="6">
              <div class="pile-label"><span>ì—´ 7</span></div>
              <div class="pile-body"></div>
            </div>
            <div class="pile pile-cascade" data-pile-type="cascade" data-index="7">
              <div class="pile-label"><span>ì—´ 8</span></div>
              <div class="pile-body"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="hint">
        <div class="pill-label">ê²Œì„ íŒ</div>
        <ul>
          <li>í•œ ë²ˆ í´ë¦­í•´ì„œ ì¹´ë“œë¥¼ ì„ íƒí•˜ê³ , ë‹¤ì‹œ í´ë¦­í•´ì„œ ëª©ì ì§€ ì¹¸(ì—´ / FREE / ê¸°ì´ˆ)ì„ ì„ íƒí•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.</li>
          <li><b>ì—´ì— ìˆëŠ” ë§¨ ìœ„ ì¹´ë“œ</b>ë¥¼ <b>ë”ë¸”í´ë¦­</b>í•˜ë©´ ë¹„ì–´ ìˆëŠ” FREE ì¹¸ìœ¼ë¡œ ìë™ ì´ë™í•©ë‹ˆë‹¤.</li>
          <li>ì´ë²ˆ ë²„ì „ì€ <b>ë§¨ ìœ„ ì¹´ë“œë§Œ ì´ë™</b>í•  ìˆ˜ ìˆê²Œ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ë‹¤ì¤‘ ì¹´ë“œ ì´ë™ì€ ë‚˜ì¤‘ì— í™•ì¥)</li>
          <li>FREE ì¹¸ì—ëŠ” ì¹´ë“œ í•œ ì¥ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆê³ , ê¸°ì´ˆ ë”ë¯¸ì—ëŠ” Aë¶€í„° ê°™ì€ ë¬´ëŠ¬ë¡œ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œë§Œ ìŒ“ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li>ì•„ë˜ ì—´ì€ ìƒ‰ê¹” êµì°¨ Â· ìˆ«ì ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œë§Œ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ë¹¨ê°• â†” ê²€ì • êµì°¨)</li>
        </ul>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½ : ì •ë³´ / ì¡°ì‘ íŒ¨ë„ -->
    <aside class="panel">
      <div class="row" style="justify-content:space-between;margin-bottom:6px;">
        <span class="pill-label">
          ëª¨ë“œ <strong style="color:#e5e7eb;">í”„ë¦¬ì…€ (FreeCell)</strong>
        </span>
        <span class="pill-label">
          ëª©í‘œ <span>ëª¨ë“  ì¹´ë“œë¥¼ ê¸°ì´ˆë¡œ ì˜¬ë¦¬ê¸°</span>
        </span>
      </div>

      <button id="btn-auto" class="big-btn">ê¸°ì´ˆë¡œ ìë™ ì´ë™</button>

      <div id="status" class="status-msg">ìƒˆ ê²Œì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>

      <div style="margin-top:10px;font-size:13px;color:var(--muted);line-height:1.4%;">
        <div style="font-weight:600;color:var(--ink);margin-bottom:4px;">ê°„ë‹¨ ê·œì¹™ ìš”ì•½</div>
        <ul style="padding-left:18px;margin:4px 0;">
          <li>ì¹´ë“œë¥¼ í´ë¦­í•´ ì„ íƒ â†’ ë‹¤ë¥¸ ì¹¸ì„ í´ë¦­í•´ ì´ë™.</li>
          <li>FREE: ì„ì‹œ ë³´ê´€ ì¹¸ (ê° ì¹¸ 1ì¥).</li>
          <li>ê¸°ì´ˆ(â™ â™¥â™£â™¦): Aë¶€í„° ê°™ì€ ë¬´ëŠ¬ë¡œ 1 â†’ 13ê¹Œì§€ ìŒ“ê¸°.</li>
          <li>ì•„ë˜ 8ê°œì˜ ì—´: ìƒ‰ê¹”ì´ êµì°¨ë˜ë©´ì„œ ìˆ«ìê°€ 1ì”© ì‘ì•„ì§€ëŠ” ì¹´ë“œë§Œ ìœ„ì— ìŒ“ì„ ìˆ˜ ìˆìŒ.</li>
          <li>â€œê¸°ì´ˆë¡œ ìë™ ì´ë™â€ / ì¹´ë“œ ì´ë™ í›„,
            <br>íŒì— ê·¸ ì¹´ë“œë³´ë‹¤ <b>ì‘ì€ ë­í¬(ìˆ«ì/ë¬¸ì)ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´</b> ê° ë¬´ëŠ¬ì— ë§ëŠ” ê¸°ì´ˆë¡œ ìë™ìœ¼ë¡œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</li>
        </ul>
      </div>

      <footer>Â© 2024 Demo_Game â€” ë„¤ì˜¨ ìŠ¤íƒ€ì¼ í”„ë¦¬ì…€ ìƒ˜í”Œ</footer>
    </aside>
  </div>
</div>

<script>
(function(){
  'use strict';

  // ì˜¬ë¼ê°€ëŠ” ê¸°ì´ˆ ë”ë¯¸ ìˆœì„œ: ìŠ¤í˜ì´ë“œ -> í•˜íŠ¸ -> í´ë¡œë²„ -> ë‹¤ì´ì•„ëª¬ë“œ
  const suits = ['â™ ','â™¥','â™£','â™¦'];

  const RANK_LABELS = {
    1:'A', 11:'J', 12:'Q', 13:'K'
  };

  const movesEl = document.getElementById('moves');
  const timeEl  = document.getElementById('time');
  const stateEl = document.getElementById('state');
  const statusBox = document.getElementById('status');
  const btnNew  = document.getElementById('btn-new');
  const btnAuto = document.getElementById('btn-auto');

  const freePileEls = Array.from(document.querySelectorAll('.pile[data-pile-type="free"]'));
  const foundationPileEls = Array.from(document.querySelectorAll('.pile[data-pile-type="foundation"]'));
  const cascadePileEls = Array.from(document.querySelectorAll('.pile[data-pile-type="cascade"]'));
  const allPileEls = Array.from(document.querySelectorAll('.pile'));

  const game = {
    free: [null,null,null,null],   // ê° FREE ì¹¸ (ì¹´ë“œ 1ì¥)
    foundations: [[],[],[],[]],    // ê° ë¬´ëŠ¬ë³„ ê¸°ì´ˆ ë”ë¯¸
    cascades: Array.from({length:8}, ()=>[]),
    moves:0,
    selected:null,                 // {pileType, pileIndex, cardIndex}
    startTime:null,
    won:false
  };

  function cardColor(card){
    return (card.suit==='â™¥' || card.suit==='â™¦') ? 'red' : 'black';
  }

  function rankLabel(rank){
    return RANK_LABELS[rank] || String(rank);
  }

  function formatTime(sec){
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return m + ':' + String(s).padStart(2,'0');
  }

  function setStatus(msg, type){
    statusBox.textContent = msg || '';
    statusBox.classList.remove('positive','negative');
    if(type==='good') statusBox.classList.add('positive');
    if(type==='bad')  statusBox.classList.add('negative');
  }

  function updateHUD(){
    const elapsed = game.startTime ? Math.floor((Date.now() - game.startTime)/1000) : 0;
    movesEl.textContent = game.moves;
    timeEl.textContent = formatTime(elapsed);
    stateEl.textContent = game.won ? 'ì™„ë£Œ!' : 'í”Œë ˆì´ ì¤‘';
  }

  function createDeck(){
    const deck = [];
    for(let s of suits){
      for(let r=1;r<=13;r++){
        deck.push({suit:s, rank:r});
      }
    }
    return deck;
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
  }

  function newGame(){
    const deck = createDeck();
    shuffle(deck);

    // ì´ˆê¸°í™”
    for(let i=0;i<4;i++) game.free[i] = null;
    for(let i=0;i<4;i++) game.foundations[i] = [];
    for(let i=0;i<8;i++) game.cascades[i] = [];

    // 8ì—´ë¡œ ìˆœì°¨ ë°°ë¶„
    for(let i=0;i<deck.length;i++){
      game.cascades[i % 8].push(deck[i]);
    }

    game.moves = 0;
    game.selected = null;
    game.startTime = Date.now();
    game.won = false;

    setStatus('ìƒˆ ê²Œì„ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ë¬¶ìŒ ì´ë™ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.','good');
    render();
  }

  function getTopCard(pileType, pileIndex){
    if(pileType === 'cascade'){
      const pile = game.cascades[pileIndex];
      if(!pile.length) return null;
      return pile[pile.length-1];
    }else if(pileType === 'free'){
      return game.free[pileIndex];
    }else if(pileType === 'foundation'){
      const pile = game.foundations[pileIndex];
      if(!pile.length) return null;
      return pile[pile.length-1];
    }
    return null;
  }

  // --- ë¬¶ìŒ ì´ë™ ê´€ë ¨ ë¡œì§ ì¶”ê°€ ---

  // í•´ë‹¹ ì—´ì˜ íŠ¹ì • ìœ„ì¹˜(index)ë¶€í„° ëê¹Œì§€ê°€ ìœ íš¨í•œ ìˆœì„œ(êµì°¨ ìƒ‰ìƒ, ë‚´ë¦¼ì°¨ìˆœ)ì¸ì§€ í™•ì¸
  function isValidSubStack(pile, startIndex){
    if(startIndex >= pile.length) return false;
    for(let i = startIndex; i < pile.length - 1; i++){
      const curr = pile[i];
      const next = pile[i+1];
      if(cardColor(curr) === cardColor(next)) return false; // ìƒ‰ìƒ ê°™ìœ¼ë©´ ì•ˆë¨
      if(curr.rank !== next.rank + 1) return false;         // ìˆ«ì ì—°ì† ì•„ë‹ˆë©´ ì•ˆë¨
    }
    return true;
  }

  // í˜„ì¬ ë¹ˆ ê³µê°„ì„ ê³ ë ¤í•œ "ìµœëŒ€ ì´ë™ ê°€ëŠ¥ ì¥ìˆ˜" ê³„ì‚°
  function getMaxMoveSize(destIsEmptyCascade){
    let emptyFree = 0;
    for(const c of game.free) if(!c) emptyFree++;

    let emptyCascades = 0;
    for(const p of game.cascades) if(p.length === 0) emptyCascades++;

    // ë§Œì•½ ëª©ì ì§€ ìì²´ê°€ ë¹ˆ ì—´ì´ë¼ë©´, 'ê²½ìœ ì§€'ë¡œì„œì˜ ë¹ˆ ì—´ ê°œìˆ˜ì—ì„œëŠ” í•˜ë‚˜ ë¹¼ì•¼ í•¨
    if(destIsEmptyCascade && emptyCascades > 0){
      emptyCascades--;
    }

    // ê³µì‹: (ë¹ˆ í”„ë¦¬ì…€ + 1) * 2^(ë¹ˆ ì—´)
    return (emptyFree + 1) * Math.pow(2, emptyCascades);
  }

  function canPlace(card, destType, destIndex){
    if(destType === 'free'){
      return !game.free[destIndex];
    }
    if(destType === 'foundation'){
      const destSuit = suits[destIndex];
      if(card.suit !== destSuit) return false;
      const pile = game.foundations[destIndex];
      if(!pile.length) return card.rank === 1;
      const top = pile[pile.length-1];
      return card.rank === top.rank + 1;
    }
    if(destType === 'cascade'){
      const pile = game.cascades[destIndex];
      if(!pile.length) return true;
      const top = pile[pile.length-1];
      if(cardColor(card) === cardColor(top)) return false;
      return card.rank === top.rank - 1;
    }
    return false;
  }

  // --- ìë™ ì´ë™ ë¡œì§ ---

  function forEachBoardCard(callback){
    for(let i=0;i<game.free.length;i++){
      const card = game.free[i];
      if(card) callback(card, 'free', i);
    }
    for(let i=0;i<game.cascades.length;i++){
      const pile = game.cascades[i];
      for(let j=0;j<pile.length;j++){
        const card = pile[j];
        callback(card, 'cascade', i, j);
      }
    }
  }

  function existsLowerRankOnBoard(rank){
    let found = false;
    forEachBoardCard(card=>{
      if(card.rank < rank){
        found = true;
      }
    });
    return found;
  }

  function canAutoMoveCardToFoundation(card){
    if(!card) return false;
    if(existsLowerRankOnBoard(card.rank)) return false;
    const destIndex = suits.indexOf(card.suit);
    if(destIndex === -1) return false;
    return canPlace(card,'foundation',destIndex);
  }

  function autoMoveSafeToFoundation(notify){
    let movedAny = false;
    let again = true;

    while(again){
      again = false;
      // 1) FREE
      for(let i=0;i<4;i++){
        const card = game.free[i];
        if(!card) continue;
        if(canAutoMoveCardToFoundation(card)){
          const destIndex = suits.indexOf(card.suit);
          if(tryMove('free', i, 'foundation', destIndex, {silent:true, cardIndex:0})){
            movedAny = true; again = true; break;
          }
        }
      }
      if(again) continue;

      // 2) Cascades
      for(let i=0;i<game.cascades.length;i++){
        const pile = game.cascades[i];
        if(!pile.length) continue;
        const card = pile[pile.length-1];
        if(canAutoMoveCardToFoundation(card)){
          const destIndex = suits.indexOf(card.suit);
          if(tryMove('cascade', i, 'foundation', destIndex, {silent:true, cardIndex: pile.length-1})){
             movedAny = true; again = true; break;
          }
        }
      }
    }

    if(notify){
      if(movedAny){
        if(game.won) setStatus('ğŸ‰ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ëª¨ë“  ì¹´ë“œë¥¼ ê¸°ì´ˆ ë”ë¯¸ë¡œ ì˜¬ë ¸ìŠµë‹ˆë‹¤.','good');
        else setStatus('ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¹´ë“œë¥¼ ê¸°ì´ˆ ë”ë¯¸ë¡œ ìë™ ì´ë™í–ˆìŠµë‹ˆë‹¤.','good');
      }else{
        setStatus('ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ìë™ ì´ë™ ê°€ëŠ¥ ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.','');
      }
    }
  }

  function checkWin(){
    let total = 0;
    for(const pile of game.foundations) total += pile.length;
    if(total === 52){
      game.won = true;
      setStatus('ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! í”„ë¦¬ì…€ì„ ëª¨ë‘ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.','good');
    }
  }

  // --- í•µì‹¬ ì´ë™ í•¨ìˆ˜ (ìˆ˜ì •ë¨) ---
  // opts.cardIndex : í•´ë‹¹ íŒŒì¼ ë‚´ì—ì„œì˜ ì¸ë±ìŠ¤ (ë¬¶ìŒ ì´ë™ì˜ ì‹œì‘ì )
  function tryMove(srcType, srcIndex, destType, destIndex, opts){
    const silent = opts && opts.silent;
    let srcCardIndex = (opts && typeof opts.cardIndex === 'number') ? opts.cardIndex : -1;

    if(game.won){
      if(!silent) setStatus('ì´ë¯¸ í´ë¦¬ì–´í•œ ê²Œì„ì…ë‹ˆë‹¤.','');
      return false;
    }
    if(srcType === 'foundation'){
      if(!silent) setStatus('ê¸°ì´ˆ ë”ë¯¸ì—ì„œëŠ” ì¹´ë“œë¥¼ êº¼ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','bad');
      return false;
    }

    // 1. ì†ŒìŠ¤ ì¹´ë“œ(ë“¤) íŠ¹ì •
    let cardsToMove = [];
    if(srcType === 'free'){
      if(!game.free[srcIndex]) return false;
      cardsToMove = [ game.free[srcIndex] ];
    } else if(srcType === 'cascade'){
      const pile = game.cascades[srcIndex];
      if(!pile.length) return false;
      // ì¸ë±ìŠ¤ê°€ ì§€ì • ì•ˆëìœ¼ë©´ ë§¨ ìœ„ ì¹´ë“œ
      if(srcCardIndex === -1) srcCardIndex = pile.length - 1;
      
      // ë¬¶ìŒ ìœ íš¨ì„± ê²€ì‚¬
      if(!isValidSubStack(pile, srcCardIndex)){
        if(!silent) setStatus('ì„ íƒí•œ ë¬¶ìŒì´ ìˆœì„œëŒ€ë¡œ ì •ë ¬ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.','bad');
        return false;
      }
      cardsToMove = pile.slice(srcCardIndex);
    }

    const headCard = cardsToMove[0]; // ì´ë™í•˜ë ¤ëŠ” ë¬¶ìŒì˜ ê°€ì¥ ì•„ë˜(ìˆ«ìê°€ í°) ì¹´ë“œ

    // 2. ëª©ì ì§€ ì°©ìˆ˜ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    // (ë¬¶ìŒì¸ ê²½ìš° headCardë§Œ ëª©ì ì§€ ë£°ì— ë§ìœ¼ë©´ ë¨. ë‚˜ë¨¸ì§€ëŠ” ì´ë¯¸ ì†ŒìŠ¤ì—ì„œ ê²€ì¦ë¨)
    if(!canPlace(headCard, destType, destIndex)){
      if(!silent) setStatus('ê·œì¹™ìƒ ê·¸ê³³ì— ë†“ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','bad');
      return false;
    }

    // 3. ë¬¶ìŒ ì´ë™ ì‹œ ìš©ëŸ‰ ì œí•œ í™•ì¸ (Cascade -> Cascade ì¸ ê²½ìš°ì—ë§Œ)
    if(srcType === 'cascade' && destType === 'cascade' && cardsToMove.length > 1){
      const destPile = game.cascades[destIndex];
      const max = getMaxMoveSize(destPile.length === 0);
      if(cardsToMove.length > max){
        if(!silent) setStatus(`ë¹ˆ ê³µê°„ ë¶€ì¡±! í˜„ì¬ ìµœëŒ€ ${max}ì¥ê¹Œì§€ë§Œ í•œ ë²ˆì— ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, 'bad');
        return false;
      }
    }
    // Cascade -> Free/Foundation ì¸ë° ì—¬ëŸ¬ ì¥ì„ ë³´ë‚´ë ¤ëŠ” ê²½ìš° ì°¨ë‹¨
    if(cardsToMove.length > 1 && (destType === 'free' || destType === 'foundation')){
       if(!silent) setStatus('í•œ ë²ˆì— í•œ ì¥ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'bad');
       return false;
    }

    // 4. ì‹¤ì œ ë°ì´í„° ì´ë™ ì‹¤í–‰
    if(srcType === 'cascade'){
      // í•´ë‹¹ ì¸ë±ìŠ¤ë¶€í„° ëê¹Œì§€ ì˜ë¼ëƒ„
      game.cascades[srcIndex].splice(srcCardIndex);
    } else if(srcType === 'free'){
      game.free[srcIndex] = null;
    }

    if(destType === 'cascade'){
      // ë¬¶ìŒ ê·¸ëŒ€ë¡œ push
      game.cascades[destIndex].push(...cardsToMove);
    } else if(destType === 'free'){
      game.free[destIndex] = headCard;
    } else if(destType === 'foundation'){
      game.foundations[destIndex].push(headCard);
    }

    if(!silent) game.moves++;
    game.selected = null;
    
    if(!silent) setStatus('ì¹´ë“œë¥¼ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'good');
    checkWin();

    if(!silent){
      autoMoveSafeToFoundation(false);
    }
    return true;
  }

  function createCardElement(card, pileType, pileIndex, cardIndex, isTop){
    const el = document.createElement('div');
    el.classList.add('card');
    el.classList.add(cardColor(card)==='red' ? 'red' : 'black');

    // ì„ íƒëœ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸ (ë¬¶ìŒì¸ ê²½ìš° í•´ë‹¹ ì¹´ë“œë§Œ í‘œì‹œ or ë¬¶ìŒ ì „ì²´ ë¡œì§)
    // ì—¬ê¸°ì„œëŠ” "í´ë¦­í•œ ì¹´ë“œ"ë§Œ ì„ íƒ í‘œì‹œ (UXìƒ ì§ê´€ì )
    if(game.selected &&
       game.selected.pileType === pileType &&
       game.selected.pileIndex === pileIndex &&
       game.selected.cardIndex === cardIndex){
      el.classList.add('selected');
    }

    el.dataset.pileType = pileType;
    el.dataset.pileIndex = String(pileIndex);
    el.dataset.cardIndex = String(cardIndex);

    const rank = rankLabel(card.rank);
    const suit = card.suit;

    el.innerHTML = `
      <div class="card-rank">${rank}</div>
      <div class="card-suit">${suit}</div>
      <div class="card-center">${suit}</div>
    `;

    el.onclick = onCardClick;
    el.ondblclick = onCardDoubleClick;

    return el;
  }

  function renderPiles(){
    // Free
    freePileEls.forEach((pileEl, index)=>{
      const body = pileEl.querySelector('.pile-body');
      body.innerHTML = '';
      const card = game.free[index];
      const hint = pileEl.querySelector('.pile-empty-hint');
      if(card){
        const cardEl = createCardElement(card,'free',index,0,true);
        cardEl.style.position = 'relative';
        body.appendChild(cardEl);
        if(hint) hint.style.display = 'none';
      }else{
        if(hint) hint.style.display = 'flex';
      }
    });

    // Foundations
    foundationPileEls.forEach((pileEl, index)=>{
      const body = pileEl.querySelector('.pile-body');
      body.innerHTML = '';
      const pile = game.foundations[index];
      const hint = pileEl.querySelector('.pile-empty-hint');
      if(pile.length){
        const card = pile[pile.length-1];
        const cardEl = createCardElement(card,'foundation',index,pile.length-1,true);
        cardEl.style.position = 'relative';
        body.appendChild(cardEl);
        if(hint) hint.style.display = 'none';
      }else{
        if(hint) hint.style.display = 'flex';
      }
    });

    // Cascades
    cascadePileEls.forEach((pileEl, index)=>{
      const body = pileEl.querySelector('.pile-body');
      body.innerHTML = '';
      const pile = game.cascades[index];
      pile.forEach((card, cardIndex)=>{
        const isTop = cardIndex === pile.length-1;
        const cardEl = createCardElement(card,'cascade',index,cardIndex,isTop);
        cardEl.style.top = (cardIndex * 24) + 'px'; // ê²¹ì¹¨ ê°„ê²©
        body.appendChild(cardEl);
      });
    });
  }

  function render(){
    renderPiles();
    updateHUD();
  }

  function onCardClick(ev){
    ev.stopPropagation();
    const el = ev.currentTarget;
    const pileType = el.dataset.pileType;
    const pileIndex = Number(el.dataset.pileIndex);
    const cardIndex = Number(el.dataset.cardIndex);
    handleCardClick(pileType, pileIndex, cardIndex);
  }

  function onCardDoubleClick(ev){
    ev.stopPropagation();
    const el = ev.currentTarget;
    const pileType = el.dataset.pileType;
    const pileIndex = Number(el.dataset.pileIndex);
    const cardIndex = Number(el.dataset.cardIndex);

    if(pileType === 'foundation'){ return; }

    // ë”ë¸”í´ë¦­ ìë™ì´ë™ì€ 1ì¥ì¼ ë•Œë§Œ (ì§ê´€ì„± ìœ„í•´)
    if(pileType === 'cascade'){
      const pile = game.cascades[pileIndex];
      if(cardIndex !== pile.length-1) return; // ë§¨ ìœ„ ì¹´ë“œë§Œ
    }

    // ë¹ˆ FREE ì¹¸ ì°¾ê¸°
    let targetFree = -1;
    for(let i=0;i<game.free.length;i++){
      if(!game.free[i]){ targetFree = i; break; }
    }
    if(targetFree === -1){
      setStatus('ë¹„ì–´ ìˆëŠ” FREE ì¹¸ì´ ì—†ìŠµë‹ˆë‹¤.','bad');
      return;
    }
    if(tryMove(pileType, pileIndex, 'free', targetFree, {cardIndex})){
      render();
    }
  }

  function handleCardClick(pileType, pileIndex, cardIndex){
    const sel = game.selected;

    // 1. ì„ íƒëœ ì¹´ë“œê°€ ì—†ì„ ë•Œ (ì†ŒìŠ¤ ì„ íƒ)
    if(!sel){
      if(pileType === 'foundation'){
        setStatus('ê¸°ì´ˆ ë”ë¯¸ëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'bad');
        return;
      }
      
      // Cascadeì—ì„œëŠ” ì¤‘ê°„ ì¹´ë“œë„ ì„ íƒ ê°€ëŠ¥í•˜ì§€ë§Œ, "ìœ íš¨í•œ ë¬¶ìŒ"ì´ì–´ì•¼ í•¨
      if(pileType === 'cascade'){
        const pile = game.cascades[pileIndex];
        // ì„ íƒí•œ ì¹´ë“œë¶€í„° ëê¹Œì§€ ìœ íš¨í•œ ì‹œí€€ìŠ¤ì¸ì§€ ê²€ì‚¬
        if(!isValidSubStack(pile, cardIndex)){
           setStatus('ì„ íƒí•œ ì¹´ë“œ ìœ„ìª½ì´ ì •ë ¬ë˜ì–´ ìˆì§€ ì•Šì•„ ë¬¶ìŒ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'bad');
           return;
        }
      }
      
      game.selected = {pileType, pileIndex, cardIndex};
      setStatus('ëª©ì ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.', '');
      render();
      return;
    }

    // 2. ì´ë¯¸ ì„ íƒëœ ìƒíƒœì—ì„œ ë‹¤ì‹œ í´ë¦­
    
    // ê°™ì€ ì¹´ë“œ(í˜¹ì€ ê°™ì€ ë”ë¯¸ì˜ ì–´ë”˜ê°€) í´ë¦­ -> ì„ íƒ í•´ì œ/ë³€ê²½
    if(sel.pileType === pileType && sel.pileIndex === pileIndex){
      // ê°™ì€ ë”ë¯¸ì˜ ë‹¤ë¥¸ ìœ íš¨í•œ ì¹´ë“œ í´ë¦­ ì‹œ ë³€ê²½
      if(pileType === 'cascade' && cardIndex !== sel.cardIndex){
         const pile = game.cascades[pileIndex];
         if(isValidSubStack(pile, cardIndex)){
           game.selected = {pileType, pileIndex, cardIndex};
           setStatus('ì„ íƒ ëŒ€ìƒì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.', '');
           render();
           return;
         }
      }
      game.selected = null;
      setStatus('ì„ íƒì„ í•´ì œí–ˆìŠµë‹ˆë‹¤.', '');
      render();
      return;
    }

    // ë‹¤ë¥¸ ê³³ í´ë¦­ -> ì´ë™ ì‹œë„
    // ëª©ì ì§€ í´ë¦­ ì‹œ cardIndexëŠ” ì¤‘ìš”í•˜ì§€ ì•ŠìŒ (ëª©ì ì§€ ë”ë¯¸ ì „ì²´ê°€ ëŒ€ìƒ)
    if(tryMove(sel.pileType, sel.pileIndex, pileType, pileIndex, {cardIndex: sel.cardIndex})){
      render();
    } else {
      // ì´ë™ ì‹¤íŒ¨ ì‹œ, ë§Œì•½ í´ë¦­í•œ ê³³ì´ ìœ íš¨í•œ ì†ŒìŠ¤ë¼ë©´ ì„ íƒ ë³€ê²½ í¸ì˜ ì œê³µ
      if(pileType === 'cascade' || pileType === 'free'){
         // (ê²€ì¦ ë¡œì§ ìƒëµí•˜ê³  ë‹¨ìˆœ í¸ì˜ìƒ ë³€ê²½ í—ˆìš© ì‹œë„)
         const pile = (pileType==='cascade') ? game.cascades[pileIndex] : [game.free[pileIndex]];
         if(pileType==='free' && !game.free[pileIndex]) return; // ë¹ˆ í”„ë¦¬ì…€ í´ë¦­ì€ ì´ë™ ì‹œë„ë§Œ

         // ìœ íš¨í•œ ë¬¶ìŒì´ë©´ ì„ íƒ ë³€ê²½
         if(pileType==='cascade' && !isValidSubStack(pile, cardIndex)) return;
         
         game.selected = {pileType, pileIndex, cardIndex};
         setStatus('ì´ë™ ë¶ˆê°€. ëŒ€ì‹  ì„ íƒ ëŒ€ìƒì„ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.', '');
         render();
      }
    }
  }

  // ë¹ˆ ê³µê°„(Pile ìì²´) í´ë¦­ ì²˜ë¦¬
  function onPileClick(ev){
    const pileEl = ev.currentTarget;
    const pileType = pileEl.dataset.pileType;
    const pileIndex = Number(el.dataset.index || pileEl.getAttribute('data-index')); // dataset í˜¸í™˜ì„±
    const sel = game.selected;

    if(!sel){
      // ë¹ˆ ê³µê°„ í´ë¦­ì€ ë¬´ì‹œ (ì¹´ë“œê°€ ì—†ìœ¼ë¯€ë¡œ)
      return;
    }

    // ê°™ì€ ê³³ í´ë¦­ ì‹œ í•´ì œ
    if(sel.pileType === pileType && sel.pileIndex === pileIndex){
      game.selected = null;
      setStatus('ì„ íƒ í•´ì œ', '');
      render();
      return;
    }

    // ì´ë™ ì‹œë„
    if(tryMove(sel.pileType, sel.pileIndex, pileType, pileIndex, {cardIndex: sel.cardIndex})){
      render();
    }
  }

  function autoMoveToFoundation(){
    autoMoveSafeToFoundation(true);
    render();
  }

  // ì´ë²¤íŠ¸
  allPileEls.forEach(el=>{
    el.onclick = onPileClick;
  });
  btnNew.addEventListener('click', newGame);
  btnAuto.addEventListener('click', autoMoveToFoundation);

  setInterval(updateHUD, 1000);
  newGame();
})();
</script>
</body>
</html>

