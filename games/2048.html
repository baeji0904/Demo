<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2048 â€“ Minimal Dark Plus</title>
<style>
  :root{
    --bg:#0e1220; --panel:#141933; --panel2:#0b0f1e; --ink:#e9edff; --muted:#9aa3c7; --accent:#7aa2ff;
    --gap:10px; --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{font-size:22px;margin:0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .btn{
    padding:8px 12px;
    border:1px solid #2a315e;
    border-radius:12px;
    background:#1b2145;
    color:var(--ink);
    cursor:pointer;
    transition:background .15s ease, box-shadow .15s ease, transform .1s ease, border-color .15s ease;
  }
  .btn:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 14px rgba(0,0,0,.4);
    border-color:#3a50ff44;
  }
  .btn:active{
    transform:translateY(0);
    box-shadow:0 3px 8px rgba(0,0,0,.65);
  }
  .btn:disabled{
    opacity:.45;
    box-shadow:none;
    transform:none;
    cursor:not-allowed;
  }
  .btn-primary{
    background:linear-gradient(180deg,#2e4cff,#2337a7);
    border-color:#3a50ff;
  }
  .tag{
    display:inline-flex;gap:8px;align-items:center;
    padding:6px 10px;
    border:1px solid #2b325c;
    border-radius:999px;
    background:#121632;
    color:var(--muted);
  }
  select{
    background:#121632;
    border:1px solid #2b325c;
    border-radius:10px;
    color:var(--ink);
    padding:6px 10px;
  }

  .panel{display:grid;grid-template-columns:minmax(280px,520px) 1fr;gap:14px}
  @media(max-width:900px){.panel{grid-template-columns:1fr}}
  .card{
    background:var(--panel);
    border:1px solid #242a49;
    border-radius:16px;
    padding:12px;
  }

  /* Board */
  .board-wrap{display:flex;justify-content:center}
  .board{
    position:relative;
    width:100%;
    max-width:520px;
    aspect-ratio:1/1;
    background:var(--panel2);
    border-radius:16px;
    padding:var(--gap);
    border:1px solid #222747;
    box-shadow:0 16px 40px rgba(0,0,0,.5);
    overflow:hidden;
  }

  /* ë³´ë“œ ë² ì ¤ + ë¹„ë„¤íŠ¸ */
  .board::before{
    content:'';
    position:absolute;
    inset:6px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.04);
    box-shadow:
      inset 0 0 0 1px rgba(0,0,0,.6),
      inset 0 12px 20px rgba(255,255,255,.03);
    pointer-events:none;
  }
  .board::after{
    content:'';
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:
      radial-gradient(circle at 50% 25%, rgba(122,162,255,.11), transparent 55%),
      radial-gradient(circle at 10% 90%, rgba(0,0,0,.6), transparent 55%);
    opacity:.9;
    mix-blend-mode:screen;
    pointer-events:none;
  }

  .grid{
    position:absolute;left:0;top:0;right:0;bottom:0;
    padding:var(--gap);
    display:grid;
    grid-template-columns:repeat(var(--size),1fr);
    grid-template-rows:repeat(var(--size),1fr);
    gap:var(--gap);
  }

  /* â–¶ ë¹ˆ ì¹¸: ì‚´ì§ íŒŒì—¬ ë³´ì´ê²Œ */
  .cell{
    background:radial-gradient(circle at 30% 25%, #202743, #050715 70%);
    border-radius:12px;
    border:1px solid #161b33;
    box-shadow:
      inset 0 3px 4px rgba(255,255,255,.04),
      inset 0 -4px 8px rgba(0,0,0,.7);
  }

  /* Tiles */
  .tiles{position:absolute;left:0;top:0;right:0;bottom:0}

  /* â–¶ ì…ì²´ê° ê°•í™”ëœ íƒ€ì¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
  .tile{
    position:absolute;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    border-radius:12px;
    user-select:none;
    transform:translate(var(--x),var(--y)) scale(1);
    transition:
      transform .12s ease,
      background .12s ease,
      color .12s ease,
      box-shadow .12s ease;
    box-shadow:
      0 14px 28px rgba(0,0,0,.45),              /* ë“œë¡­ ì„€ë„ìš° */
      0 0 0 1px rgba(255,255,255,.04),          /* ì•½í•œ ì™¸ê³½ì„  */
      inset 0 2px 3px rgba(255,255,255,.18),    /* ìœ„ìª½ í•˜ì´ë¼ì´íŠ¸ */
      inset 0 -4px 8px rgba(0,0,0,.45);         /* ì•„ë˜ìª½ ì–´ë‘ìš´ ë©´ */
    background-clip:padding-box;
    overflow:hidden;
    text-shadow:0 1px 2px rgba(0,0,0,.45);
  }

  /* ìƒˆë¡œ ìƒì„± íƒ€ì¼ íŒ ì• ë‹ˆë©”ì´ì…˜ */
  .tile.new{animation:pop .15s ease-out}
  @keyframes pop{
    0%{
      transform:translate(var(--x),var(--y)) scale(.6);
      opacity:0;
    }
    60%{
      transform:translate(var(--x),var(--y)) scale(1.08);
      opacity:1;
    }
    100%{
      transform:translate(var(--x),var(--y)) scale(1);
      opacity:1;
    }
  }

  /* í•©ì²´ ì‹œ ìŠ¤ì¿¼ì‹œÂ·ìŠ¤íŠ¸ë ˆì¹˜ */
  .tile.merged-tile{
    animation:mergePulse .14s ease-out;
  }
  @keyframes mergePulse{
    0%{
      transform:translate(var(--x),var(--y)) scale(.95,1.05);
    }
    50%{
      transform:translate(var(--x),var(--y)) scale(1.06,.94);
    }
    100%{
      transform:translate(var(--x),var(--y)) scale(1,1);
    }
  }

  /* í° ê°’ í•©ì²´ ì‹œ ì¢€ ë” ê³¼í•œ í„ìŠ¤ */
  .tile.big-merge{
    animation:bigMerge .35s ease-out;
  }
  @keyframes bigMerge{
    0%{
      transform:translate(var(--x),var(--y)) scale(.9);
      box-shadow:
        0 18px 40px rgba(0,0,0,.8),
        0 0 0 0 rgba(255,214,133,.0);
    }
    40%{
      transform:translate(var(--x),var(--y)) scale(1.12);
      box-shadow:
        0 20px 48px rgba(0,0,0,.9),
        0 0 22px 6px rgba(255,214,133,.5);
    }
    100%{
      transform:translate(var(--x),var(--y)) scale(1);
      box-shadow:
        0 18px 40px rgba(0,0,0,.6),
        0 0 18px rgba(255,214,133,.35);
    }
  }

  /* â–¶ íƒ€ì¼ ìœ ë¦¬ í•˜ì´ë¼ì´íŠ¸/ìŒì˜ */
  .tile::before{
    content:'';
    position:absolute;
    inset:4px 6px 58% 6px; /* ìœ„ìª½ ì˜ì—­ë§Œ ë°˜ì§ì´ê²Œ */
    border-radius:inherit;
    background:linear-gradient(
      180deg,
      rgba(255,255,255,.45),
      rgba(255,255,255,0)
    );
    opacity:.9;
    pointer-events:none;
    mix-blend-mode:screen;
  }
  .tile::after{
    content:'';
    position:absolute;
    inset:2px;
    border-radius:inherit;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.35),
      inset 0 -10px 18px rgba(0,0,0,.55);
    opacity:.8;
    pointer-events:none;
  }

  /* Colors by value */
  .t-2{background:#2b355e;color:#dfe7ff}
  .t-4{background:#273b70;color:#e9f1ff}
  .t-8{background:#21408e;color:#fff}
  .t-16{background:#1f469e;color:#fff}
  .t-32{background:#1b4db1;color:#fff}
  .t-64{background:#1454c8;color:#fff}
  .t-128{background:#0c72d4;color:#fff}
  .t-256{background:#0787da;color:#fff}
  .t-512{background:#06a0e0;color:#fff}
  .t-1024{background:#10b981;color:#052d25}
  .t-2048{background:#ffd685;color:#3a2c00}
  .t-big{
    background:linear-gradient(135deg,#ffd685,#ff9aa2,#b79cff);
    color:#161616;
  }

  /* â–¶ í° ê°’ íƒ€ì¼ì€ ë” ê°•í•œ ë„¤ì˜¨ ê¸€ë¡œìš° */
  .t-1024,
  .t-2048,
  .t-big{
    box-shadow:
      0 18px 40px rgba(0,0,0,.6),
      0 0 18px rgba(255,214,133,.35),
      inset 0 2px 4px rgba(255,255,255,.22),
      inset 0 -5px 10px rgba(0,0,0,.55);
  }

  .aside{color:var(--muted);font-size:14px}
  .kbd{
    display:inline-grid;
    place-items:center;
    border:1px solid #2b325c;
    border-radius:8px;
    padding:0 6px;
    height:24px;
    background:#121632;
    color:#cfd6ff;
  }

  .muted{opacity:.7}

  /* ë¬´íš¨ ì´ë™ ì‹œ ë³´ë“œ í”ë“¤ê¸° */
  .board.shake{
    animation:shake .18s ease;
  }
  @keyframes shake{
    0%{transform:translateX(0);}
    20%{transform:translateX(-4px);}
    40%{transform:translateX(4px);}
    60%{transform:translateX(-2px);}
    80%{transform:translateX(2px);}
    100%{transform:translateX(0);}
  }

  /* ì ìˆ˜ í”Œë¡œíŒ… ì´í™íŠ¸ */
  .score-float{
    position:absolute;
    pointer-events:none;
    font-size:15px;
    font-weight:600;
    color:#ffd685;
    text-shadow:0 0 6px rgba(0,0,0,.8);
    animation:scoreFloat .6s ease-out forwards;
    z-index:8;
  }
  @keyframes scoreFloat{
    0%{
      opacity:0;
      transform:translate(calc(var(--x)), calc(var(--y) + 10px)) scale(.9);
    }
    20%{
      opacity:1;
    }
    100%{
      opacity:0;
      transform:translate(calc(var(--x)), calc(var(--y) - 26px)) scale(1.05);
    }
  }

  /* ê²Œì„ ì˜¤ë²„ ì˜¤ë²„ë ˆì´ */
  .overlay{
    position:absolute;
    inset:var(--gap);
    border-radius:14px;
    background:radial-gradient(circle at 50% 0%, rgba(15,23,42,.9), rgba(15,23,42,.98));
    backdrop-filter:blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    opacity:0;
    pointer-events:none;
    transition:opacity .25s ease;
    z-index:10;
  }
  .overlay.show{
    opacity:1;
    pointer-events:auto;
  }
  .overlay-inner{
    text-align:center;
    padding:16px 20px;
    border-radius:16px;
    border:1px solid #2b325c;
    background:linear-gradient(180deg,#141933,#050716);
    box-shadow:0 16px 40px rgba(0,0,0,.7);
  }
  .overlay-title{
    font-size:20px;
    margin-bottom:4px;
  }
  .overlay-sub{
    font-size:13px;
    color:var(--muted);
    margin-bottom:12px;
  }
  .overlay-score{
    margin-bottom:10px;
    font-size:15px;
  }
  .overlay-score b{
    font-size:18px;
    color:#ffd685;
  }

  /* ëª¨ì…˜ ë¯¼ê° ì‚¬ìš©ì ëŒ€ì‘ */
  @media (prefers-reduced-motion: reduce){
    *, *::before, *::after{
      animation-duration:.001ms !important;
      animation-iteration-count:1 !important;
      transition:none !important;
      scroll-behavior:auto !important;
    }
    .board.shake{
      animation:none !important;
    }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>2048 Demo</h1>
    <div class="row">
      <span class="tag">ì ìˆ˜ <b id="score">0</b></span>
      <span class="tag">ìµœê³  <b id="best">0</b></span>
      <label class="tag">í¬ê¸°
        <select id="size">
          <option value="4" selected>4Ã—4</option>
          <option value="5">5Ã—5</option>
          <option value="6">6Ã—6</option>
        </select>
      </label>
      <button id="new" class="btn btn-primary">ìƒˆ ê²Œì„</button>
      <button id="undo" class="btn">ì‹¤í–‰ì·¨ì†Œ</button>
      <button id="mute" class="btn" aria-pressed="false">ğŸ”Š ìŒì†Œê±°</button>
    </div>
  </header>

  <div class="panel">
    <div class="card">
      <div class="board-wrap">
        <div id="board" class="board" style="--size:4">
          <div class="grid" id="grid"></div>
          <div class="tiles" id="tiles"></div>
          <div class="overlay" id="overlay">
            <div class="overlay-inner">
              <div class="overlay-title">ê²Œì„ ì¢…ë£Œ</div>
              <div class="overlay-sub">ì›€ì§ì¼ ìˆ˜ ìˆëŠ” ë¸”ë¡ì´ ì—†ì–´ìš”.</div>
              <div class="overlay-score">
                ìµœì¢… ì ìˆ˜: <b id="finalScore">0</b>
              </div>
              <button class="btn btn-primary" id="overlayRestart">ë‹¤ì‹œ ì‹œì‘</button>
            </div>
          </div>
        </div>
      </div>
      <div class="aside" style="margin-top:8px">
        â†â†‘â†’â†“ ë˜ëŠ” <span class="kbd">W</span><span class="kbd">A</span><span class="kbd">S</span><span class="kbd">D</span>, í„°ì¹˜ ìŠ¤ì™€ì´í”„ ì§€ì›. ê°™ì€ ìˆ«ìë¥¼ í•©ì¹˜ë©´ ì ìˆ˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤. 2048ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!
      </div>
    </div>
    <div class="card">
      <div style="color:#9aa3c7">íŒ</div>
      <ul class="aside">
        <li>í•œ ë²ˆì˜ <b>ì‹¤í–‰ì·¨ì†Œ</b>ê°€ ê°€ëŠ¥í•´ìš”.</li>
        <li><b>ìŒì†Œê±°</b>ë¡œ íš¨ê³¼ìŒì„ ë„ê³  ì¼¤ ìˆ˜ ìˆì–´ìš”.</li>
        <li>ê·¸ë¦¬ë“œ í¬ê¸°ë¥¼ ë°”ê¾¸ë©´ ìƒˆ ê²Œì„ì´ ì‹œì‘ë¼ìš”.</li>
      </ul>
      <div class="aside muted">ë””ìì¸ íŒ”ë ˆíŠ¸ëŠ” ì˜ˆì „ ë²½ëŒê¹¨ê¸°/ì²´ìŠ¤ì™€ í†µì¼ëœ ë‹¤í¬ í†¤ì…ë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  // ===== Elements =====
  const elBoard = document.getElementById('board');
  const elGrid  = document.getElementById('grid');
  const elTiles = document.getElementById('tiles');
  const elScore = document.getElementById('score');
  const elBest  = document.getElementById('best');
  const elSize  = document.getElementById('size');
  const btnNew  = document.getElementById('new');
  const btnUndo = document.getElementById('undo');
  const btnMute = document.getElementById('mute');
  const elOverlay = document.getElementById('overlay');
  const elFinalScore = document.getElementById('finalScore');
  const btnOverlayRestart = document.getElementById('overlayRestart');

  // ===== State =====
  const SAVE_KEY_PREFIX = 'g2048.best.';
  let N = 4;
  let GRID = []; // 2D array of tile or null
  let nextId = 1;
  let score = 0, best = Number(localStorage.getItem(SAVE_KEY_PREFIX+N) || 0);
  let history = null; // {gridJSON, score}
  let muted = false;

  // ===== Audio (WebAudio minimal beeps) =====
  const audio = (() => {
    const ctx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
    function beep(freq=440, dur=0.06, gain=0.04){
      if(!ctx || muted) return;
      const t0 = ctx.currentTime, osc = ctx.createOscillator(), g = ctx.createGain();
      osc.type = 'sine'; osc.frequency.value = freq;
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(gain, t0+0.005);
      g.gain.linearRampToValueAtTime(0, t0+dur);
      osc.connect(g).connect(ctx.destination);
      osc.start(t0); osc.stop(t0+dur+0.01);
    }
    return {
      move(){ beep(300,0.04,0.03); },
      merge(v){ // pitch by value
        const f = 220 + Math.log2(v)*60;
        beep(f,0.08,0.06);
      },
      spawn(){ beep(520,0.03,0.03); },
      over(){ beep(150,0.2,0.06); }
    };
  })();

  // ===== Utils =====
  const rnd = (n)=> Math.floor(Math.random()*n);
  const serialize = (g)=> JSON.stringify(g.map(r=>r.map(t=>t?{v:t.v,id:t.id}:null)));
  const deserialize = (s)=> JSON.parse(s).map(r=>r.map(t=>t?{v:t.v,id:t.id}:null));

  // Pixel helpers for tile layout
  function computeCellSize(){
    const rect = elBoard.getBoundingClientRect();
    const gap = parseFloat(getComputedStyle(elBoard).getPropertyValue('--gap')) || 10;
    const inner = rect.width - gap*2;
    const cell = (inner - gap*(N-1)) / N;
    return {cell, gap};
  }
  function setTilePos(el, r, c){
    const {cell, gap} = computeCellSize();
    const x = gap + c*(cell+gap);
    const y = gap + r*(cell+gap);
    el.style.setProperty('--x', x+'px');
    el.style.setProperty('--y', y+'px');
    el.style.width = cell+'px';
    el.style.height = cell+'px';
    el.style.fontSize = (cell*0.42)+'px';
  }
  function classFor(v){
    if(v>=2048) return 't-big';
    const map = {2:'t-2',4:'t-4',8:'t-8',16:'t-16',32:'t-32',64:'t-64',128:'t-128',256:'t-256',512:'t-512',1024:'t-1024',2048:'t-2048'};
    return map[v] || 't-big';
  }

  function updateHUD(){
    elScore.textContent = score;
    elBest.textContent = best;
    btnUndo.disabled = !history;
  }

  // ===== Rendering =====
  function drawGrid(){
    elBoard.style.setProperty('--size', N);
    elGrid.innerHTML = '';
    for(let i=0;i<N*N;i++){
      const d = document.createElement('div');
      d.className = 'cell';
      elGrid.appendChild(d);
    }
  }

  function drawTiles(prevMap, mergedIds, mergeEffects){
    mergedIds = mergedIds || [];
    mergeEffects = mergeEffects || [];

    elTiles.innerHTML = '';
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const t = GRID[r][c]; if(!t) continue;
        const el = document.createElement('div');
        el.className = 'tile '+classFor(t.v)+(t.new?' new':''); t.new=false;
        el.dataset.id = t.id;
        el.textContent = t.v;
        setTilePos(el, r, c);
        // if moved, animate from previous pos
        if(prevMap && prevMap[t.id]){
          const {r:pr, c:pc} = prevMap[t.id];
          if(pr!==r || pc!==c){
            setTilePos(el, pr, pc);
            // force reflow then move
            el.getBoundingClientRect();
            setTilePos(el, r, c);
          }
        }

        // í•©ì²´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ë¶€ì—¬
        if(mergedIds.includes(t.id)){
          if(t.v >= 512){
            el.classList.add('big-merge');
          }else{
            el.classList.add('merged-tile');
          }
        }

        elTiles.appendChild(el);
      }
    }

    // ì ìˆ˜ í”Œë¡œíŒ… ì´í™íŠ¸
    if(mergeEffects.length){
      const geom = computeCellSize();
      const {cell, gap} = geom;
      for(const eff of mergeEffects){
        const fx = gap + eff.c*(cell+gap) + cell/2;
        const fy = gap + eff.r*(cell+gap) + cell/2;
        const floatEl = document.createElement('div');
        floatEl.className = 'score-float';
        floatEl.textContent = '+'+eff.value;
        floatEl.style.setProperty('--x', (fx - 14) + 'px');
        floatEl.style.setProperty('--y', (fy - 14) + 'px');
        elTiles.appendChild(floatEl);
        floatEl.addEventListener('animationend', ()=> floatEl.remove());
      }
    }

    updateHUD();
  }

  // ===== Game Logic =====
  function emptyCells(){
    const cells=[];
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(!GRID[r][c]) cells.push({r,c});
    return cells;
  }

  function addRandomTile(){
    const cells = emptyCells();
    if(!cells.length) return false;
    const {r,c} = cells[rnd(cells.length)];
    GRID[r][c] = {id:nextId++, v: Math.random()<0.9?2:4, new:true};
    audio.spawn();
    return true;
  }

  function startGame(){
    history = null;
    score = 0;
    N = Number(elSize.value);
    best = Number(localStorage.getItem(SAVE_KEY_PREFIX+N) || 0);
    GRID = Array.from({length:N},()=>Array(N).fill(null));
    nextId = 1;
    drawGrid();
    addRandomTile(); addRandomTile();
    if(elOverlay) elOverlay.classList.remove('show');
    drawTiles();
  }

  function canMove(){
    if(emptyCells().length) return true;
    // check merges
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const v=GRID[r][c]?.v;
        if(c+1<N && GRID[r][c+1]?.v===v) return true;
        if(r+1<N && GRID[r+1][c]?.v===v) return true;
      }
    }
    return false;
  }

  function triggerShake(){
    elBoard.classList.remove('shake');
    // reflow
    void elBoard.offsetWidth;
    elBoard.classList.add('shake');
  }

  function showGameOver(){
    elFinalScore.textContent = score;
    elOverlay.classList.add('show');
  }

  function move(dir){ // dir: 'left','right','up','down'
    const vec = {left:{dr:0,dc:-1}, right:{dr:0,dc:1}, up:{dr:-1,dc:0}, down:{dr:1,dc:0}}[dir];
    const rangeR = [...Array(N).keys()];
    const rangeC = [...Array(N).keys()];
    if(dir==='right') rangeC.reverse();
    if(dir==='down') rangeR.reverse();

    // save for undo
    history = {gridJSON: serialize(GRID), score};

    // track previous positions
    const prevPos = {};
    for(let r=0;r<N;r++) for(let c=0;c<N;c++){ const t=GRID[r][c]; if(t) prevPos[t.id]={r,c}; }

    let moved=false;
    const mergedIds = [];
    const mergeEffects = [];

    // reset merge flags
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(GRID[r][c]) GRID[r][c].merged=false;

    const step = (r,c)=>{
      const tile = GRID[r][c]; if(!tile) return;
      let nr=r, nc=c;
      while(true){
        const tr = nr+vec.dr, tc = nc+vec.dc;
        if(tr<0||tr>=N||tc<0||tc>=N) break;
        const t2 = GRID[tr][tc];
        if(!t2){ nr=tr; nc=tc; continue; }
        if(!t2.merged && t2.v===tile.v){ // merge
          nr=tr; nc=tc; break;
        }
        break;
      }
      if(nr===r && nc===c) return;
      moved=true;
      const dest = GRID[nr][nc];
      if(dest && dest.v===tile.v && !dest.merged){
        // merge
        const newValue = dest.v * 2;
        const newId = nextId++;
        GRID[nr][nc] = {id:newId, v:newValue};
        GRID[nr][nc].merged = true;
        score += newValue;
        audio.merge(newValue);
        mergedIds.push(newId);
        mergeEffects.push({id:newId, r:nr, c:nc, value:newValue});
      }else{
        GRID[nr][nc] = tile;
      }
      GRID[r][c] = null;
    };

    if(dir==='left' || dir==='right'){
      for(const r of rangeR) for(const c of rangeC) step(r,c);
    }else{
      for(const c of rangeC) for(const r of rangeR) step(r,c);
    }

    if(!moved){
      // no change -> drop history & ë³´ë“œ í”ë“¤ê¸°
      history = null;
      triggerShake();
      updateHUD();
      return false;
    }

    audio.move();

    // clear merged flags (ì‹¤ì œ ë¡œì§ìƒ í•œ ë²ˆë§Œ í•©ì³ì§€ë„ë¡ ìœ ì§€í•˜ê¸° ìœ„í•´)
    for(let r=0;r<N;r++) for(let c=0;c<N;c++) if(GRID[r][c]) GRID[r][c].merged=false;

    // spawn new
    addRandomTile();

    // update best
    if(score>best){
      best=score;
      localStorage.setItem(SAVE_KEY_PREFIX+N,best);
    }

    // draw with animation info
    drawTiles(prevPos, mergedIds, mergeEffects);

    if(!canMove()){
      audio.over();
      showGameOver();
    }
    return true;
  }

  // ===== Input =====
  window.addEventListener('keydown', (e)=>{
    const k = e.key;
    if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','a','A','d','D','w','W','s','S'].includes(k)) e.preventDefault();
    const map = {
      ArrowLeft:'left', ArrowRight:'right', ArrowUp:'up', ArrowDown:'down',
      a:'left', A:'left', d:'right', D:'right', w:'up', W:'up', s:'down', S:'down'
    };
    const dir = map[k]; if(dir) move(dir);
  });

  // Touch swipe
  let tStart=null;
  elBoard.addEventListener('touchstart',(e)=>{
    if(e.touches.length===1)
      tStart={x:e.touches[0].clientX,y:e.touches[0].clientY,t:Date.now()};
  }, {passive:true});
  elBoard.addEventListener('touchmove',(e)=>{}, {passive:true});
  elBoard.addEventListener('touchend',(e)=>{
    if(!tStart) return;
    const dx = (e.changedTouches[0].clientX - tStart.x);
    const dy = (e.changedTouches[0].clientY - tStart.y);
    const ax = Math.abs(dx), ay = Math.abs(dy);
    if(Math.max(ax,ay) > 20){
      if(ax>ay) move(dx>0?'right':'left');
      else move(dy>0?'down':'up');
    }
    tStart=null;
  });

  // Buttons
  btnNew.addEventListener('click', ()=> startGame());
  btnUndo.addEventListener('click', ()=>{
    if(!history) return;
    GRID = deserialize(history.gridJSON).map(row=>row.map(t=>t?{...t}:null));
    // restore nextId safely
    nextId = 1 + GRID.flat().reduce((m,t)=> t?Math.max(m,t.id):m,0);
    score = history.score;
    history = null;
    if(elOverlay) elOverlay.classList.remove('show');
    drawGrid(); drawTiles();
  });
  btnMute.addEventListener('click', ()=>{
    muted = !muted;
    btnMute.textContent = muted? 'ğŸ”‡ ìŒì†Œê±° í•´ì œ' : 'ğŸ”Š ìŒì†Œê±°';
    btnMute.setAttribute('aria-pressed', String(muted));
  });
  elSize.addEventListener('change', ()=> startGame());
  window.addEventListener('resize', ()=> drawTiles());

  if(btnOverlayRestart){
    btnOverlayRestart.addEventListener('click', ()=>{
      startGame();
    });
  }

  // Simple toast (í˜„ì¬ëŠ” ì˜ˆë¹„ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©)
  let toastTimer=null;
  function toast(msg){
    let el = document.getElementById('toast');
    if(!el){
      el = document.createElement('div');
      el.id='toast';
      el.style.position='fixed';
      el.style.left='50%'; el.style.top='16px';
      el.style.transform='translateX(-50%)';
      el.style.padding='8px 12px';
      el.style.background='#1b2145';
      el.style.border='1px solid #2b325c';
      el.style.borderRadius='10px';
      el.style.color='var(--ink)';
      el.style.zIndex='999';
      document.body.appendChild(el);
    }
    el.textContent=msg; el.style.opacity='1';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ el.style.transition='opacity .3s'; el.style.opacity='0'; }, 1300);
  }

  // ===== Boot =====
  startGame();
})();
</script>
</body>
</html>
