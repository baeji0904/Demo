<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brick Breaker â€“ Full Sound Build</title>
  <style>
    :root{
      --bg:#050716;
      --ink:#e9edff;
      --muted:#97a2c5;
      --panel:#171a2f;
      --accent:#7aa2ff;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:
        radial-gradient(circle at 0% 0%, #1f2455 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #32216b 0, transparent 55%),
        #050716;
      color:var(--ink);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto;
    }
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    h1{font-size:22px;margin:0}
    .btn{
      padding:8px 12px;
      border:1px solid #2a315e;
      border-radius:12px;
      background:#141a3d;
      color:var(--ink);
      cursor:pointer;
      font-size:13px;
      transition:background .15s ease,border-color .15s ease,transform .05s ease;
    }
    .btn:hover{background:#1b2250;border-color:#3b4a88}
    .btn:active{transform:scale(.97)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{
      background:linear-gradient(135deg,#3b5cff,#2337a7);
      border-color:#4a63ff;
      box-shadow:0 0 0 1px rgba(78,110,255,.35),0 10px 24px rgba(12,23,87,.8);
    }
    .panel{
      background:var(--panel);
      border:1px solid #242a49;
      border-radius:16px;
      padding:12px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
    }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .tag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border:1px solid #2b325c;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      background:rgba(6,9,32,.9);
      box-shadow:0 8px 18px rgba(0,0,0,.5);
      backdrop-filter:blur(8px);
    }
    .seg{display:flex;gap:6px;flex-wrap:wrap}
    canvas{
      width:100%;
      height:auto;
      background:transparent;
      border-radius:14px;
      touch-action:none;
      box-shadow:0 22px 40px rgba(0,0,0,.75);
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ë²½ëŒê¹¨ê¸° Demo</h1>
    <div class="row">
      <button id="btn-start" class="btn btn-primary">ì‹œì‘ / ì¬ì‹œì‘</button>
      <button id="btn-pause" class="btn">ì¼ì‹œì •ì§€</button>
      <button id="btn-reset" class="btn">í•˜ì´ìŠ¤ì½”ì–´ ì´ˆê¸°í™”</button>
      <button id="btn-mute" class="btn">ğŸ”Š íš¨ê³¼ìŒ ì¼œì§</button>
    </div>
  </header>

  <div id="hud" class="row" style="margin:10px 0">
    <span class="tag">ì ìˆ˜ <strong id="score">0</strong></span>
    <span class="tag">ë ˆë²¨ <strong id="level">1</strong></span>
    <span class="tag">ëª©ìˆ¨ <strong id="lives">3</strong></span>
    <span class="tag">ìµœê³ ê¸°ë¡ <strong id="best">0</strong></span>
  </div>

  <div class="row" id="speed-controls" style="margin:6px 0 10px">
    <span class="tag">ë°°ì†</span>
    <div class="seg">
      <button class="btn" data-speed="0">ë§¤ìš° ëŠë¦¼ Ã—0.5</button>
      <button class="btn" data-speed="1">ëŠë¦¼ Ã—0.75</button>
      <button class="btn btn-primary" data-speed="2">ë³´í†µ Ã—1</button>
      <button class="btn" data-speed="3">ë¹ ë¦„ Ã—1.25</button>
      <button class="btn" data-speed="4">ë§¤ìš° ë¹ ë¦„ Ã—1.5</button>
    </div>
  </div>

  <div class="row" id="difficulty-controls" style="margin:6px 0 10px">
    <span class="tag">ë‚œì´ë„</span>
    <div class="seg">
      <button class="btn" data-diff="0">Easy</button>
      <button class="btn btn-primary" data-diff="1">Normal</button>
      <button class="btn" data-diff="2">Hard</button>
    </div>
    <span class="tag" id="diff-desc">ê³µì†â†“ íŒ¨ë“¤â†‘ ë¼ì´í”„â†‘ (í˜„ì¬: Normal)</span>
  </div>

  <div class="panel">
    <canvas id="game" width="800" height="600" aria-label="Brick Breaker"></canvas>
    <div class="row" style="margin-top:8px">
      <button id="left" class="btn">â—€ ì™¼ìª½</button>
      <button id="right" class="btn">ì˜¤ë¥¸ìª½ â–¶</button>
    </div>
    <div style="color:#97a2c5;font-size:14px;margin-top:6px">
      í‚¤ë³´ë“œ: â† â†’ ë˜ëŠ” A/D, ìŠ¤í˜ì´ìŠ¤: <b>ë°œì‚¬/ì¼ì‹œì •ì§€</b>. í„°ì¹˜: ìº”ë²„ìŠ¤ ë“œë˜ê·¸ ë˜ëŠ” ë²„íŠ¼ ì‚¬ìš©.
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  // ===== Canvas & Constants =====
  var CANVAS = document.getElementById('game');
  var CTX = CANVAS.getContext('2d');
  var DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
  var saveKey = 'breakout.fullsound.best';
  var muteKey = 'breakout.fullsound.muted';

  var WORLD = {
    w:800, h:600, wall:10,
    paddle:{ w:120, h:16, y:560, speed:520 },
    ball:{ r:8, speed:360 },
    bricks:{ w:80, h:24, gap:6, top:80 }
  };

  var C = {
    bg:'#050817',
    ink:'#e9edff',
    muted:'#9ea7c8',
    wall:'#1b2145',
    paddle:'#8ef6d0',
    ball:'#7aa2ff',
    brickByHp:{
      1:'#7aa2ff', // hp1
      2:'#8ef6d0', // hp2
      3:'#ffd685', // hp3
      4:'#ff9aa2'  // hp4
    }
  };

  // ===== Levels (5) =====
  var LEVELS = [
    ['11111111','11111111','11111111','11111111'],
    ['22222222','211..112','211..112','22222222'],
    ['2.1111.2','221..122','221..122','2.1111.2','2.222222'],
    ['..3333..','.322223.','32222223','32222223','.322223.','..3333..'],
    ['4.33333.4','44.222.44','444.1.444','44.222.44','4.33333.4']
  ];

  // ===== Speed & Difficulty =====
  var SPEEDS = [0.5, 0.75, 1.0, 1.25, 1.5];
  var DIFFS = [
    { name:'Easy',   ballMul:0.9,  paddleMul:1.2, lives:5, desc:'ê³µì†â†“ íŒ¨ë“¤â†‘ ë¼ì´í”„â†‘' },
    { name:'Normal', ballMul:1.0,  paddleMul:1.0, lives:3, desc:'ê¸°ë³¸ê°’' },
    { name:'Hard',   ballMul:1.15, paddleMul:0.85, lives:2, desc:'ê³µì†â†‘ íŒ¨ë“¤â†“ ë¼ì´í”„â†“' }
  ];

  // ===== State =====
  var S = {
    running:false, paused:false, won:false,
    level:1, score:0, lives:3,
    best:Number(localStorage.getItem(saveKey)||0),
    speedIndex:2, diffIndex:1,
    paddleScale:1, shield:false,
    paddleX:(WORLD.w-120)/2,
    balls:[], bricks:[],
    muted:(localStorage.getItem(muteKey)==='1')
  };

  // ===== Audio (Web Audio SFX) =====
  var AC = null; var lastSfxAt = {};
  function ensureAC(){ if(!AC){ try{ AC=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ AC=null; } } }
  function unlockAudio(){ if(AC && AC.state==='suspended') AC.resume(); }
  window.addEventListener('pointerdown', unlockAudio, {once:true});
  window.addEventListener('keydown',  unlockAudio, {once:true});

  function sfx(type){
    if(S.muted) return; ensureAC(); if(!AC) return;
    var now = AC.currentTime;
    var minGap = { wall:0.03, brick:0.02 }[type] || 0;
    if(lastSfxAt[type] && now-lastSfxAt[type] < minGap) return;
    lastSfxAt[type] = now;

    var f1=440,f2=440,dur=0.08,wave='sine',vol=0.12;
    if(type==='paddle'){ f1=260; f2=330; dur=0.08; wave='square';   vol=0.15; }
    else if(type==='wall'){   f1=200; f2=220; dur=0.05; wave='triangle'; vol=0.10; }
    else if(type==='brick'){  f1=520; f2=660; dur=0.06; wave='square';  vol=0.12; }
    else if(type==='break'){  f1=660; f2=440; dur=0.12; wave='sawtooth'; vol=0.16; }
    else if(type==='drop'){   f1=740; f2=880; dur=0.08; wave='triangle'; vol=0.12; }
    else if(type==='power'){  f1=820; f2=980; dur=0.12; wave='sawtooth'; vol=0.14; }
    else if(type==='shield'){ f1=440; f2=660; dur=0.16; wave='sine';    vol=0.14; }
    else if(type==='life'){   f1=440; f2=220; dur=0.25; wave='triangle'; vol=0.18; }
    else if(type==='level'){
      ['triangle','triangle','triangle'].forEach(function(tt,i){
        var o=AC.createOscillator(), g=AC.createGain(), t=AC.currentTime+i*0.06;
        o.type=tt;
        o.frequency.setValueAtTime([523.25,659.25,783.99][i], t);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.14, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.16);
        o.connect(g); g.connect(AC.destination);
        o.start(t); o.stop(t+0.18);
      });
      return;
    }

    var o = AC.createOscillator(), g = AC.createGain();
    o.type=wave; o.connect(g); g.connect(AC.destination);
    o.frequency.setValueAtTime(f1, now);
    o.frequency.linearRampToValueAtTime(f2, now+dur);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(vol, now+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    o.start(now); o.stop(now+dur+0.02);
  }

  // ===== Mute Toggle =====
  var muteBtn = document.getElementById('btn-mute');
  function updateMuteUI(){
    muteBtn.textContent = S.muted ? 'ğŸ”‡ íš¨ê³¼ìŒ êº¼ì§' : 'ğŸ”Š íš¨ê³¼ìŒ ì¼œì§';
  }
  muteBtn.addEventListener('click', function(){
    S.muted = !S.muted;
    localStorage.setItem(muteKey, S.muted ? '1':'0');
    updateMuteUI();
  });
  updateMuteUI();

  // ===== Helpers =====
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

  function roundRect(ctx,x,y,w,h,r){
    var rr=Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.lineTo(x+w-rr,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+rr);
    ctx.lineTo(x+w,y+h-rr);
    ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
    ctx.lineTo(x+rr,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-rr);
    ctx.lineTo(x,y+rr);
    ctx.quadraticCurveTo(x,y,x+rr,y);
    ctx.closePath();
    ctx.fill();
  }

  // ìƒ‰ ë°ê¸° ì¡°ì ˆ (í…ŒíŠ¸ë¦¬ìŠ¤ì—ì„œ ì“°ë˜ ë°©ì‹)
  function adjustColor(hex, amt){
    if(!hex || hex.startsWith('rgba')) return hex;
    var c = hex.replace('#','');
    if(c.length===3) c = c.split('').map(function(ch){return ch+ch;}).join('');
    var num = parseInt(c,16);
    var r = (num>>16)&255, g=(num>>8)&255, b=num&255;
    function adj(v){ return Math.max(0,Math.min(255,Math.round(v*(1+amt)))); }
    r=adj(r); g=adj(g); b=adj(b);
    function toHex(v){ return v.toString(16).padStart(2,'0'); }
    return '#'+toHex(r)+toHex(g)+toHex(b);
  }

  function brickColor(hp){
    hp = Math.max(1, Math.min(4, hp));
    return C.brickByHp[hp];
  }

  function PW(){
    return Math.max(40, WORLD.paddle.w * S.paddleScale * DIFFS[S.diffIndex].paddleMul);
  }

  function fitCanvas(){
    var cssW=CANVAS.clientWidth;
    var ratio=cssW/WORLD.w;
    CANVAS.style.height=(WORLD.h*ratio)+'px';
    CANVAS.width=Math.floor(WORLD.w*DPR);
    CANVAS.height=Math.floor(WORLD.h*DPR);
    CTX.setTransform(DPR,0,0,DPR,0,0);
  }

  function updateHUD(){
    document.getElementById('score').textContent=S.score;
    document.getElementById('level').textContent=S.level;
    document.getElementById('lives').textContent=S.lives;
    document.getElementById('best').textContent=S.best;
    document.getElementById('btn-pause').textContent=S.paused?'ê³„ì†í•˜ê¸°':'ì¼ì‹œì •ì§€';
    document.getElementById('diff-desc').textContent=DIFFS[S.diffIndex].desc+' (í˜„ì¬: '+DIFFS[S.diffIndex].name+')';
  }

  function makeBall(){
    var spd = WORLD.ball.speed * (1 + (S.level-1)*0.05) * DIFFS[S.diffIndex].ballMul;
    return {
      x:S.paddleX+PW()/2,
      y:WORLD.paddle.y-12,
      vx:spd*0.7,
      vy:-spd*0.8,
      stuck:true,
      pierce:false
    };
  }

  function resetBalls(){ S.balls=[makeBall()]; }

  function buildBricks(){
    var g = LEVELS[Math.min(LEVELS.length, Math.max(1, S.level)) - 1];
    var cols = Math.max.apply(null, g.map(function(row){ return row.length; }));
    var rows = g.length;
    var B=WORLD.bricks;
    var totalW = cols*B.w + (cols-1)*B.gap;
    var left=(WORLD.w-totalW)/2;
    S.bricks=[];
    for(var y=0;y<rows;y++){
      for(var x=0;x<cols;x++){
        var ch=(g[y]&&g[y][x])||'.';
        if(ch==='.') continue;
        var hp=Math.max(1,parseInt(ch,10)||1);
        S.bricks.push({
          x:left+x*(B.w+B.gap),
          y:B.top+y*(B.h+B.gap),
          w:B.w,
          h:B.h,
          hp:hp,
          color:brickColor(hp)
        });
      }
    }
  }

  function resetLevel(){
    buildBricks();
    S.paddleX=(WORLD.w-PW())/2;
    resetBalls();
  }

  // ===== Input =====
  var keys = new Set();
  var dragging=false, lastX=0;

  window.addEventListener('keydown', function(e){
    if(['ArrowLeft','ArrowRight','a','A','d','D',' '].indexOf(e.key) >= 0) e.preventDefault();
    if(e.key===' '){
      if(S.balls.some(function(b){return b.stuck;})) releaseBalls();
      else togglePause();
      return;
    }
    if(['ArrowLeft','a','A'].indexOf(e.key) >= 0) keys.add('left');
    if(['ArrowRight','d','D'].indexOf(e.key) >= 0) keys.add('right');
  });
  window.addEventListener('keyup', function(e){
    if(['ArrowLeft','a','A'].indexOf(e.key) >= 0) keys.delete('left');
    if(['ArrowRight','d','D'].indexOf(e.key) >= 0) keys.delete('right');
  });

  CANVAS.addEventListener('pointerdown', function(e){
    dragging=true;
    lastX=e.clientX;
    if(S.balls.some(function(b){return b.stuck;})) releaseBalls();
  });
  CANVAS.addEventListener('pointermove', function(e){
    if(!dragging) return;
    var dx=e.clientX-lastX;
    lastX=e.clientX;
    S.paddleX=clamp(S.paddleX+dx*1.2, WORLD.wall, WORLD.w-WORLD.wall-PW());
  });
  ['pointerup','pointercancel','pointerleave'].forEach(function(t){
    CANVAS.addEventListener(t, function(){ dragging=false; });
  });

  document.getElementById('left').addEventListener('pointerdown', function(){ keys.add('left'); });
  document.getElementById('right').addEventListener('pointerdown', function(){ keys.add('right'); });
  ['pointerup','pointercancel','pointerleave'].forEach(function(t){
    document.getElementById('left').addEventListener(t, function(){ keys.delete('left'); });
    document.getElementById('right').addEventListener(t, function(){ keys.delete('right'); });
  });

  // ===== Buttons =====
  function selectButtons(sel, idx, attr){
    var btns=document.querySelectorAll(sel);
    for(var i=0;i<btns.length;i++){
      var b=btns[i];
      var v=Number(b.getAttribute(attr));
      if(v===idx) b.classList.add('btn-primary');
      else b.classList.remove('btn-primary');
    }
  }

  document.querySelectorAll('#speed-controls [data-speed]').forEach(function(b){
    b.addEventListener('click', function(){
      S.speedIndex=Number(b.getAttribute('data-speed'));
      selectButtons('#speed-controls [data-speed]', S.speedIndex, 'data-speed');
    });
  });

  document.querySelectorAll('#difficulty-controls [data-diff]').forEach(function(b){
    b.addEventListener('click', function(){
      S.diffIndex=Number(b.getAttribute('data-diff'));
      S.lives=DIFFS[S.diffIndex].lives;
      S.paddleScale=1;
      resetLevel();
      updateHUD();
      selectButtons('#difficulty-controls [data-diff]', S.diffIndex, 'data-diff');
    });
  });

  selectButtons('#speed-controls [data-speed]', S.speedIndex, 'data-speed');
  selectButtons('#difficulty-controls [data-diff]', S.diffIndex, 'data-diff');

  // ===== Drops / Powerups =====
  var DROP_TYPES=['EXP','SHR','SHD','MBL'];
  var DROP_LABEL={EXP:'â†­',SHR:'ã€“',SHD:'ğŸ›¡',MBL:'â—'};
  var DROP_STYLE={ size:24, hit:26, vy:140 };
  var drops=[];

  function spawnDrop(x,y){
    drops.push({x:x,y:y,vy:DROP_STYLE.vy,kind:DROP_TYPES[Math.floor(Math.random()*DROP_TYPES.length)]});
    sfx('drop');
  }

  function applyDrop(kind){
    if(kind==='EXP'){
      S.paddleScale=Math.min(2.0,S.paddleScale*1.3);
      sfx('power');
    } else if(kind==='SHR'){
      S.paddleScale=Math.max(0.6,S.paddleScale*0.75);
      sfx('power');
    } else if(kind==='SHD'){
      S.shield=true;
      sfx('shield');
    } else if(kind==='MBL'){
      if(S.balls.length<8){
        var base=S.balls[0];
        var sp=Math.hypot(base.vx,base.vy);
        var a=(Math.random()*0.8-0.4);
        var dir=Math.random()<0.5?-1:1;
        var nb={
          x:base.x+6,
          y:base.y,
          vx:dir*Math.cos(a)*sp,
          vy:-Math.abs(Math.sin(a)*sp),
          stuck:false,
          pierce:false
        };
        S.balls.push(nb);
        sfx('power');
      }
    }
    updateHUD();
  }

  // ===== Game Control =====
  document.getElementById('btn-start').onclick=function(){ startGame(true); };
  document.getElementById('btn-pause').onclick=function(){ togglePause(); };
  document.getElementById('btn-reset').onclick=function(){
    localStorage.removeItem(saveKey);
    S.best=0;
    updateHUD();
  };

  function startGame(reset){
    if(reset){
      S.level=1;
      S.score=0;
      S.lives=DIFFS[S.diffIndex].lives;
    }
    S.won=false;
    S.running=true;
    S.paused=false;
    S.paddleScale=1;
    S.shield=false;
    resetLevel();
    updateHUD();
  }

  function togglePause(){
    if(!S.running){
      startGame(false);
      return;
    }
    S.paused=!S.paused;
    updateHUD();
  }

  function releaseBalls(){ S.balls.forEach(function(b){ b.stuck=false; }); }

  // ===== Physics =====
  function rectIntersect(ax,ay,aw,ah,bx,by,bw,bh){
    return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
  }

  function step(dt){
    var R=WORLD.ball.r;
    var sp=WORLD.paddle.speed*dt;
    if(keys.has('left')) S.paddleX-=sp;
    if(keys.has('right')) S.paddleX+=sp;
    S.paddleX=clamp(S.paddleX, WORLD.wall, WORLD.w-WORLD.wall-PW());

    // balls
    for(var bi=0; bi<S.balls.length; bi++){
      var b=S.balls[bi];
      if(b.stuck){
        b.x=S.paddleX+PW()/2;
        b.y=WORLD.paddle.y-12;
      } else {
        b.x+=b.vx*dt;
        b.y+=b.vy*dt;
      }

      // walls
      if(b.x-R < WORLD.wall){
        b.x=WORLD.wall+R;
        b.vx*=-1;
        sfx('wall');
      }
      if(b.x+R > WORLD.w-WORLD.wall){
        b.x=WORLD.w-WORLD.wall-R;
        b.vx*=-1;
        sfx('wall');
      }
      if(b.y-R < WORLD.wall){
        b.y=WORLD.wall+R;
        b.vy*=-1;
        sfx('wall');
      }

      // paddle
      if(b.vy>0 && rectIntersect(
        b.x-R,b.y-R,R*2,R*2,
        S.paddleX, WORLD.paddle.y, PW(), WORLD.paddle.h
      )){
        b.y=WORLD.paddle.y-R;
        var hit=(b.x-(S.paddleX+PW()/2))/(PW()/2);
        var speed=Math.hypot(b.vx,b.vy)*1.02;
        var angle=hit*(Math.PI/3);
        b.vx=Math.sin(angle)*speed;
        b.vy=-Math.cos(angle)*speed;
        b.stuck=false;
        sfx('paddle');
      }

      // bricks
      for(var i=0;i<S.bricks.length;i++){
        var br=S.bricks[i];
        if(br.hp<=0) continue;
        if(rectIntersect(
          b.x-R,b.y-R,R*2,R*2,
          br.x,br.y,br.w,br.h
        )){
          var overlapX=(br.x+br.w/2)-b.x;
          var overlapY=(br.y+br.h/2)-b.y;
          if(Math.abs(overlapX/br.w) > Math.abs(overlapY/br.h))
            b.vx*=-1;
          else
            b.vy*=-1;

          br.hp-=1;
          sfx('brick');
          if(br.hp>0){
            br.color = brickColor(br.hp);
          }
          if(br.hp<=0){
            S.score+=10;
            if(S.score>S.best){
              S.best=S.score;
              localStorage.setItem(saveKey,S.best);
            }
            if(Math.random()<0.2)
              spawnDrop(br.x+br.w/2, br.y+br.h/2);
            sfx('break');
          }
          break;
        }
      }
    }

    // drops
    for(var di=drops.length-1; di>=0; di--){
      var d=drops[di];
      d.y+=DROP_STYLE.vy*dt;
      var hs=DROP_STYLE.hit/2;
      if(rectIntersect(
        d.x-hs,d.y-hs,DROP_STYLE.hit,DROP_STYLE.hit,
        S.paddleX, WORLD.paddle.y, PW(), WORLD.paddle.h
      )){
        applyDrop(d.kind);
        drops.splice(di,1);
        continue;
      }
      if(d.y>WORLD.h) drops.splice(di,1);
    }

    // ë¯¸ìŠ¤ ì²˜ë¦¬
    S.balls = S.balls.filter(function(b){
      if(b.y-R<=WORLD.h) return true;
      if(S.shield){
        b.y=WORLD.h-WORLD.wall-R-2;
        b.vy=-Math.abs(b.vy);
        S.shield=false;
        updateHUD();
        sfx('shield');
        return true;
      }
      return false;
    });

    if(S.balls.length===0){
      S.lives-=1;
      updateHUD();
      sfx('life');
      if(S.lives<=0){
        S.running=false;
        S.paused=false;
        resetLevel();
      } else {
        resetBalls();
      }
    }

    // ë ˆë²¨ í´ë¦¬ì–´
    if(S.bricks.every(function(x){ return x.hp<=0; })){
      if(S.level<5){
        S.level+=1;
        S.lives=Math.min(9,S.lives+1);
        resetLevel();
        updateHUD();
        sfx('level');
      } else {
        S.running=false;
        S.paused=false;
        S.won=true;
        updateHUD();
        sfx('level');
      }
    }
  }

  // ===== Render helpers (ê·¸ë˜í”½ ì—…ê·¸ë ˆì´ë“œ) =====
  function drawBackground(){
    var w=WORLD.w, h=WORLD.h;
    var g = CTX.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'#050818');
    g.addColorStop(0.5,'#050b23');
    g.addColorStop(1,'#02030b');
    CTX.fillStyle=g;
    CTX.fillRect(0,0,w,h);

    var vg = CTX.createRadialGradient(w/2,h/2,0,w/2,h/2,Math.max(w,h));
    vg.addColorStop(0,'rgba(0,0,0,0)');
    vg.addColorStop(1,'rgba(0,0,0,0.55)');
    CTX.fillStyle=vg;
    CTX.fillRect(0,0,w,h);
  }

  function drawFrameAndWalls(){
    var w=WORLD.w, h=WORLD.h, t=WORLD.wall;
    CTX.save();

    // outer frame
    var fx = t*0.4, fy = t*0.4, fw = w - t*0.8, fh = h - t*0.8;
    var frameGrad = CTX.createLinearGradient(0,fy,0,fy+fh);
    frameGrad.addColorStop(0,'#25325f');
    frameGrad.addColorStop(1,'#151a3a');
    CTX.fillStyle = 'rgba(0,0,0,0.75)';
    roundRect(CTX, fx-3, fy-3, fw+6, fh+6, 20);
    CTX.fillStyle = frameGrad;
    roundRect(CTX, fx, fy, fw, fh, 18);

    // inner playfield background (ì‚´ì§ ì–´ë‘ìš´ ì˜ì—­)
    var ix = t, iy = t, iw = w - t*2, ih = h - t*2;
    var innerGrad = CTX.createLinearGradient(0,iy,0,iy+ih);
    innerGrad.addColorStop(0,'#050818');
    innerGrad.addColorStop(1,'#030413');
    CTX.fillStyle = innerGrad;
    CTX.fillRect(ix,iy,iw,ih);

    // subtle edge glow
    CTX.strokeStyle='rgba(120,150,255,0.55)';
    CTX.lineWidth=1.2;
    CTX.strokeRect(ix+0.5,iy+0.5,iw-1,ih-1);

    CTX.restore();
  }

  function drawPaddle(){
    var x=S.paddleX, y=WORLD.paddle.y, w=PW(), h=WORLD.paddle.h;
    var base=C.paddle;
    var light=adjustColor(base,0.3);
    var dark=adjustColor(base,-0.25);
    var grad=CTX.createLinearGradient(x,y,x,y+h);
    grad.addColorStop(0,light);
    grad.addColorStop(0.5,base);
    grad.addColorStop(1,dark);

    CTX.save();
    CTX.shadowColor='rgba(0,0,0,0.6)';
    CTX.shadowBlur=10;
    CTX.shadowOffsetY=3;

    CTX.fillStyle=grad;
    roundRect(CTX,x,y,w,h,8);

    // highlight line
    CTX.shadowColor='transparent';
    CTX.beginPath();
    CTX.moveTo(x+4,y+3);
    CTX.lineTo(x+w-4,y+3);
    CTX.strokeStyle='rgba(255,255,255,0.45)';
    CTX.lineWidth=1;
    CTX.stroke();

    CTX.restore();
  }

  function drawBall(b){
    var r=WORLD.ball.r;
    CTX.save();
    CTX.shadowColor='rgba(120,170,255,0.7)';
    CTX.shadowBlur=15;
    CTX.shadowOffsetY=3;

    var grad=CTX.createRadialGradient(b.x-2,b.y-3,1,b.x,b.y,r);
    grad.addColorStop(0,'#ffffff');
    grad.addColorStop(0.2,'#f2f5ff');
    grad.addColorStop(0.8,C.ball);
    grad.addColorStop(1,adjustColor(C.ball,-0.3));
    CTX.fillStyle=grad;
    CTX.beginPath();
    CTX.arc(b.x,b.y,r,0,Math.PI*2);
    CTX.fill();

    CTX.restore();
  }

  function drawBrick(br){
    var x=br.x, y=br.y, w=br.w, h=br.h, r=6;
    var base=br.color;
    var light=adjustColor(base,0.35);
    var dark=adjustColor(base,-0.25);

    CTX.save();
    CTX.shadowColor='rgba(0,0,0,0.45)';
    CTX.shadowBlur=8;
    CTX.shadowOffsetY=3;

    var grad=CTX.createLinearGradient(x,y,x,y+h);
    grad.addColorStop(0,light);
    grad.addColorStop(0.45,base);
    grad.addColorStop(1,dark);
    CTX.fillStyle=grad;
    roundRect(CTX,x,y,w,h,r);

    // gloss
    CTX.shadowColor='transparent';
    var glossH = h*0.45;
    var glossGrad=CTX.createLinearGradient(x,y,x,y+glossH);
    glossGrad.addColorStop(0,'rgba(255,255,255,0.75)');
    glossGrad.addColorStop(1,'rgba(255,255,255,0)');
    CTX.fillStyle=glossGrad;
    roundRect(CTX,x+1,y+1,w-2,glossH,r*0.7);

    // border
    CTX.strokeStyle=adjustColor(base,-0.55);
    CTX.lineWidth=1;
    CTX.strokeRect(x+0.5,y+0.5,w-1,h-1);

    CTX.restore();
  }

  function drawDrop(dp){
    var size = DROP_STYLE.size;
    var hs = size/2;
    var x = dp.x-hs, y=dp.y-hs, r=hs;

    CTX.save();
    CTX.shadowColor='rgba(0,0,0,0.6)';
    CTX.shadowBlur=8;
    CTX.shadowOffsetY=2;

    var g = CTX.createLinearGradient(x,y,x,y+size);
    g.addColorStop(0,'rgba(15,30,70,0.95)');
    g.addColorStop(1,'rgba(12,18,40,0.95)');
    CTX.fillStyle=g;
    roundRect(CTX,x,y,size,size,10);

    CTX.shadowColor='transparent';
    CTX.strokeStyle='rgba(150,190,255,0.75)';
    CTX.lineWidth=1;
    CTX.strokeRect(x+0.5,y+0.5,size-1,size-1);

    CTX.fillStyle='#f9fbff';
    CTX.font='16px system-ui';
    CTX.textAlign='center';
    CTX.textBaseline='middle';
    CTX.fillText(DROP_LABEL[dp.kind]||'â˜…', dp.x, dp.y+1);

    CTX.restore();
  }

  function drawShieldBar(active){
    var pad=4, h=10;
    var x=WORLD.wall+pad;
    var w=WORLD.w-(WORLD.wall+pad)*2;
    var y=WORLD.h-WORLD.wall-pad-h;
    CTX.save();
    var base = active ? 'rgba(142,246,208,0.55)' : 'rgba(142,246,208,0.18)';
    var g = CTX.createLinearGradient(x,y,x,y+h);
    g.addColorStop(0,base);
    g.addColorStop(1,'rgba(20,40,40,0.1)');
    CTX.fillStyle=g;
    roundRect(CTX,x,y,w,h,8);
    CTX.strokeStyle = active ? 'rgba(142,246,208,0.9)' : 'rgba(142,246,208,0.5)';
    CTX.lineWidth=1.4;
    CTX.strokeRect(x+0.5,y+0.5,w-1,h-1);
    CTX.restore();
  }

  function overlay(text){
    var subtitle = 'Space / ì‹œì‘ ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ í”Œë ˆì´';

    CTX.save();
    CTX.fillStyle='rgba(3,4,14,0.55)';
    CTX.fillRect(0,0,WORLD.w,WORLD.h);

    // measure
    CTX.font='bold 26px system-ui';
    var titleW = CTX.measureText(text).width;
    CTX.font='12px system-ui';
    var subW = CTX.measureText(subtitle).width;

    var padX = 32;
    var minW = 320;
    var maxW = WORLD.w - 80;
    var boxW = Math.max(titleW, subW) + padX*2;
    boxW = Math.min(Math.max(boxW,minW),maxW);
    var boxH = 120;
    var x = (WORLD.w-boxW)/2;
    var y = (WORLD.h-boxH)/2;

    var g = CTX.createLinearGradient(x,y,x,y+boxH);
    g.addColorStop(0,'rgba(20,30,90,0.98)');
    g.addColorStop(1,'rgba(10,18,60,0.98)');
    CTX.fillStyle=g;
    roundRect(CTX,x,y,boxW,boxH,20);

    CTX.strokeStyle='rgba(150,180,255,0.8)';
    CTX.lineWidth=2;
    CTX.strokeRect(x+0.5,y+0.5,boxW-1,boxH-1);

    CTX.fillStyle='#f7f8ff';
    CTX.font='bold 26px system-ui';
    CTX.textAlign='center';
    CTX.textBaseline='middle';
    CTX.fillText(text, WORLD.w/2, y+boxH/2-16);

    CTX.fillStyle='rgba(190,198,255,0.9)';
    CTX.font='12px system-ui';
    CTX.fillText(subtitle, WORLD.w/2, y+boxH/2+16);

    CTX.restore();
  }

  // ===== Render main =====
  function draw(){
    drawBackground();
    drawFrameAndWalls();

    if (S.shield) {
      drawShieldBar(true);
    }

    // paddle
    drawPaddle();

    // balls
    for(var i=0;i<S.balls.length;i++){
      drawBall(S.balls[i]);
    }

    // bricks
    for(var j=0;j<S.bricks.length;j++){
      var br=S.bricks[j];
      if(br.hp<=0) continue;
      drawBrick(br);
    }

    // drops
    for(var k=0;k<drops.length;k++){
      drawDrop(drops[k]);
    }

    // hint text
    CTX.fillStyle=C.muted;
    CTX.textAlign='left';
    CTX.textBaseline='alphabetic';
    CTX.font='14px system-ui';
    CTX.fillText('Space: ë°œì‚¬/ì¼ì‹œì •ì§€', WORLD.wall+12, WORLD.wall+22);

    if(!S.running && !S.paused && !S.won){
      overlay('ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš” / Press Start');
    }
    if(S.paused){
      overlay('ì¼ì‹œì •ì§€ / Paused');
    }
    if(S.won){
      overlay('ëª¨ë“  ë ˆë²¨ í´ë¦¬ì–´!');
    }

    // ì•„ì§ ì‹¤ë“œê°€ ì—†ê³  ê²Œì„ ì‹œì‘ ì „ì´ë©´ íë¦° ì‹¤ë“œ ìŠ¬ë¡¯ ë³´ì—¬ì£¼ê¸°
    if (!S.shield && !S.running && !S.paused && !S.won) {
      drawShieldBar(false);
    }
  }

  // ===== Loop & Boot =====
  var last=0;
  function loop(ts){
    requestAnimationFrame(loop);
    if(!S.running || S.paused){
      draw();
      return;
    }
    if(!last) last=ts;
    var base=Math.min(0.02,(ts-last)/1000);
    last=ts;
    var dt=base*SPEEDS[S.speedIndex];
    step(dt);
    draw();
  }

  window.addEventListener('resize', fitCanvas);
  fitCanvas();
  updateHUD();
  draw();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
